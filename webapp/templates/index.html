<!doctype html>
<html>
<head>
    <title>Modern LTspice Prototype</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
    <style>
        body{font-family:sans-serif;background:#f2f7fb;}
        #palette{border:1px solid #ccc;padding:10px;width:140px;float:left;background:#fff;border-radius:4px;}
        #palette .item{padding:6px;margin:4px;border:1px solid #888;cursor:pointer;background:#dfe9ff;border-radius:3px;text-align:center;}
        #palette .item:hover{background:#c2d7ff;}
        #canvas{border:1px solid #ccc;height:360px;margin-left:160px;position:relative;background:#ffffff;border-radius:4px;}
        .component{position:absolute;text-align:center;font-size:12px;}
        .component input{width:40px;font-size:12px;}
        .component select{font-size:12px;}
        .component .value{font-size:10px;color:#555;}
        #netlist{width:100%;background:#f7f7f7;border:1px solid #ccc;border-radius:4px;}
        #errorMsg{color:red;}
    </style>
</head>
<body>
    <h1>Modern LTspice Prototype</h1>
    <div id="palette">
        <div class="item" data-type="V" draggable="true">Voltage</div>
        <div class="item" data-type="R" draggable="true">Resistor</div>
        <div class="item" data-type="C" draggable="true">Capacitor</div>
        <div class="item" data-type="GND" draggable="true">Ground</div>
    </div>
    <div id="canvas"></div>
    <form id="form" onsubmit="runSimulation(); return false;">
        <textarea name="netlist" id="netlist" rows="10" cols="60">{{ netlist }}</textarea><br>
        <button type="submit">Run Simulation</button>
    </form>
    <p id="errorMsg">{% if error %}{{ error }}{% endif %}</p>
    <h2 id="chartTitle" style="display:none;">Simulation Result</h2>
    <canvas id="chart" style="display:none;"></canvas>

<script>
const instance = jsPlumb.getInstance({Container:"canvas"});
instance.bind("connection", updateNetlist);
instance.bind("connectionDetached", updateNetlist);
instance.bind("connectionMoved", updateNetlist);
const counts = {V:1,R:1,C:1,GND:1};
const shapes = {
    R:`<svg width="80" height="30" viewBox="0 0 80 30">
            <polyline points="0,15 10,15 15,5 25,25 35,5 45,25 55,5 65,25 70,15 80,15" stroke="black" fill="none" stroke-width="2"/>
        </svg>`,
    C:`<svg width="60" height="30" viewBox="0 0 60 30">
            <line x1="0" y1="15" x2="15" y2="15" stroke="black" stroke-width="2"/>
            <line x1="25" y1="0" x2="25" y2="30" stroke="black" stroke-width="2"/>
            <line x1="35" y1="0" x2="35" y2="30" stroke="black" stroke-width="2"/>
            <line x1="45" y1="15" x2="60" y2="15" stroke="black" stroke-width="2"/>
        </svg>`,
    V:`<svg width="60" height="60" viewBox="0 0 60 60">
            <line x1="0" y1="30" x2="10" y2="30" stroke="black" stroke-width="2"/>
            <circle cx="30" cy="30" r="18" stroke="black" fill="none" stroke-width="2"/>
            <line x1="30" y1="12" x2="30" y2="48" stroke="black" stroke-width="2"/>
            <line x1="18" y1="30" x2="42" y2="30" stroke="black" stroke-width="2"/>
            <text x="34" y="20" font-size="10" fill="black">+</text>
            <text x="34" y="41" font-size="10" fill="black">-</text>
            <line x1="50" y1="30" x2="60" y2="30" stroke="black" stroke-width="2"/>
        </svg>`,
    GND:`<svg width="40" height="30" viewBox="0 0 40 30">
            <line x1="20" y1="0" x2="20" y2="5" stroke="black" stroke-width="2"/>
            <line x1="10" y1="5" x2="30" y2="5" stroke="black" stroke-width="2"/>
            <line x1="12" y1="10" x2="28" y2="10" stroke="black" stroke-width="2"/>
            <line x1="14" y1="15" x2="26" y2="15" stroke="black" stroke-width="2"/>
        </svg>`
};

function addComponent(type,x,y){
    const id=type+counts[type]++;
    const d=document.createElement('div');
    d.className='component';
    d.id=id;
    d.dataset.type=type;
    const prefixOpts=['','p','n','u','m','', 'k','M','G'];
    const valueDefault=type==='V'?5:1;
    const prefixDefault=type==='V'?'':'k';
    let prefOptions='';
    prefixOpts.forEach(p=>{prefOptions+=`<option value="${p}" ${p===prefixDefault?'selected':''}>${p}</option>`});
    d.innerHTML=`<div class="label">${id}</div>${shapes[type]}<div class="inputs"><input class="val" value="${valueDefault}"> <select class="pref">${prefOptions}</select></div><div class="value"></div>`;
    d.style.left=x+'px';
    d.style.top=y+'px';
    document.getElementById('canvas').appendChild(d);
    instance.draggable(d);
    if(type!=='GND'){
        instance.addEndpoint(d,{anchor:"Left",isSource:true,isTarget:true,uuid:id+"-a"});
        instance.addEndpoint(d,{anchor:"Right",isSource:true,isTarget:true,uuid:id+"-b"});
    }else{
        instance.addEndpoint(d,{anchor:"Left",isSource:true,isTarget:true,uuid:id+"-g"});
    }
    d.querySelectorAll('input,select').forEach(el=>el.addEventListener('change',updateNetlist));
    updateNetlist();
}

document.querySelectorAll('#palette .item').forEach(el=>{
    el.addEventListener('dragstart',e=>{
        e.dataTransfer.setData('type',el.dataset.type);
    });
    el.addEventListener('click',e=>{
        addComponent(el.dataset.type,20,20);
    });
});

document.getElementById('canvas').addEventListener('dragover',e=>e.preventDefault());
document.getElementById('canvas').addEventListener('drop',e=>{
    e.preventDefault();
    const type=e.dataTransfer.getData('type');
    addComponent(type,e.offsetX,e.offsetY);
});

function updateNetlist(){
    const uf={};
    function find(x){if(!(x in uf))uf[x]=x;return uf[x]==x?x:uf[x]=find(uf[x]);}
    function union(a,b){a=find(a);b=find(b);if(a!=b)uf[a]=b;}
    const allE=[];
    instance.getAllConnections().forEach(c=>{
        union(c.endpoints[0].getUuid(),c.endpoints[1].getUuid());
    });
    document.querySelectorAll('.component').forEach(div=>{
        const t=div.dataset.type,id=div.id;
        if(t==='GND'){allE.push(id+'-g');uf[id+'-g']=id+'-g';}
        else{allE.push(id+'-a');allE.push(id+'-b');}
    });
    const nodeMap={};
    let next=1;
    allE.forEach(ep=>{
        const root=find(ep);
        const comp=ep.split('-')[0];
        if(document.getElementById(comp).dataset.type==='GND')nodeMap[root]=0;
    });
    allE.forEach(ep=>{const r=find(ep);if(nodeMap[r]==null)nodeMap[r]=next++;});
    const prefixPowers={p:-12,n:-9,u:-6,m:-3,'':0,k:3,M:6,G:9};
    const lines=[];
    document.querySelectorAll('.component').forEach(div=>{
        const t=div.dataset.type,id=div.id;
        if(t==='GND')return;
        const n1=nodeMap[find(id+'-a')];
        const n2=nodeMap[find(id+'-b')];
        const val=div.querySelector('input.val').value||'1';
        const pref=div.querySelector('select.pref').value||'';
        const num=parseFloat(val)*Math.pow(10,prefixPowers[pref]||0);
        const sci=num.toExponential();
        div.querySelector('.value').textContent=sci;
        if(t==='R')lines.push(`${id} ${n1} ${n2} ${sci}`);
        if(t==='C')lines.push(`${id} ${n1} ${n2} ${sci}`);
        if(t==='V')lines.push(`${id} ${n1} ${n2} DC ${sci}`);
    });
    lines.push('.tran 1m 20m');
    const nodes=Object.values(nodeMap).filter(n=>n!==0);
    if(nodes.length)lines.push('.print tran '+nodes.map(n=>`v(${n})`).join(' '));
    lines.push('.end');
    document.getElementById('netlist').value=lines.join('\n');
}
let chart=null;
let lastError=null;
let errorCount=0;
function renderChart(data){
    const times=data.map(r=>r[0]);
    const s1=data.map(r=>r[1]);
    const s2=data[0].length>2?data.map(r=>r[2]):[];
    const ctx=document.getElementById('chart');
    document.getElementById('chart').style.display='block';
    document.getElementById('chartTitle').style.display='block';
    if(chart){chart.destroy();}
    chart=new Chart(ctx,{type:'line',data:{labels:times,datasets:[{label:'V(node1)',data:s1,borderColor:'red',fill:false},{label:'V(node2)',data:s2,borderColor:'blue',fill:false}]},options:{scales:{x:{title:{display:true,text:'Time (s)'}},y:{title:{display:true,text:'Voltage (V)'}}}}});
}

function runSimulation(){
    updateNetlist();
    const form=new FormData();
    form.append('netlist',document.getElementById('netlist').value);
    fetch('/run',{method:'POST',body:form}).then(r=>r.json()).then(res=>{
        if(res.error){
            document.getElementById('errorMsg').textContent=res.error;
            if(lastError===res.error){
                errorCount++;
                if(errorCount>=2) alert('Repeated error: '+res.error);
            }else{lastError=res.error;errorCount=1;}
        }else{
            document.getElementById('errorMsg').textContent='';
            lastError=null;errorCount=0;
            renderChart(res.data);
        }
    });
}

setInterval(runSimulation,5000);
</script>
</body>
</html>
