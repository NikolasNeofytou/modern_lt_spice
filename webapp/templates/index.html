<!doctype html>
<html>
<head>
    <title>Modern LTspice Prototype</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
    <style>
        body{font-family:sans-serif;}
        #palette{border:1px solid #ccc;padding:10px;width:120px;float:left;}
        #palette .item{padding:4px;margin:4px;border:1px solid #888;cursor:move;background:#eee;}
        #canvas{border:1px solid #ccc;height:300px;margin-left:140px;position:relative;}
        .component{position:absolute;padding:2px 4px;border:1px solid #666;background:#f8f8f8;width:70px;text-align:center;font-size:12px;}
        #netlist{width:100%;}
    </style>
</head>
<body>
    <h1>Modern LTspice Prototype</h1>
    <div id="palette">
        <div class="item" data-type="V" draggable="true">Voltage</div>
        <div class="item" data-type="R" draggable="true">Resistor</div>
        <div class="item" data-type="C" draggable="true">Capacitor</div>
        <div class="item" data-type="GND" draggable="true">Ground</div>
    </div>
    <div id="canvas"></div>
    <form method="post" id="form">
        <textarea name="netlist" id="netlist" rows="10" cols="60">{{ netlist }}</textarea><br>
        <button type="submit" onclick="generateNetlist()">Run Simulation</button>
    </form>
    {% if error %}
    <p style="color:red;">{{ error }}</p>
    {% endif %}
    {% if data %}
    <h2>Simulation Result</h2>
    <canvas id="chart"></canvas>
    {% endif %}

<script>
const instance = jsPlumb.getInstance({Container:"canvas"});
const counts = {V:1,R:1,C:1,GND:1};
const shapes = {
    R:`<svg width="60" height="20"><polyline points="0,10 10,10 15,5 20,15 25,5 30,15 35,5 40,15 45,10 55,10" stroke="black" fill="none"/></svg>`,
    C:`<svg width="40" height="20"><line x1="10" y1="0" x2="10" y2="20" stroke="black"/><line x1="20" y1="0" x2="20" y2="20" stroke="black"/></svg>`,
    V:`<svg width="40" height="40"><circle cx="20" cy="20" r="15" stroke="black" fill="none"/><line x1="20" y1="5" x2="20" y2="35" stroke="black"/><line x1="5" y1="20" x2="35" y2="20" stroke="black"/></svg>`,
    GND:`<svg width="40" height="20"><line x1="20" y1="0" x2="20" y2="5" stroke="black"/><line x1="10" y1="5" x2="30" y2="5" stroke="black"/><line x1="12" y1="8" x2="28" y2="8" stroke="black"/><line x1="14" y1="11" x2="26" y2="11" stroke="black"/></svg>`
};

function addComponent(type,x,y){
    const id=type+counts[type]++;
    const d=document.createElement('div');
    d.className='component';
    d.id=id;
    d.dataset.type=type;
    const val=prompt(`Enter value for ${type}`, type==='V'?'5':'1');
    const pref=prompt('Enter prefix (none,k,M,m,u,n,p)', type==='V'?'':'k');
    d.dataset.value=val;
    d.dataset.prefix=pref;
    d.innerHTML=`<div>${id}</div>${shapes[type]}<div>${val}${pref}</div>`;
    d.style.left=x+'px';
    d.style.top=y+'px';
    document.getElementById('canvas').appendChild(d);
    instance.draggable(d);
    if(type!=='GND'){
        instance.addEndpoint(d,{anchor:"Left"},{uuid:id+"-a"});
        instance.addEndpoint(d,{anchor:"Right"},{uuid:id+"-b"});
    }else{
        instance.addEndpoint(d,{anchor:"Left"},{uuid:id+"-g"});
    }
}

document.querySelectorAll('#palette .item').forEach(el=>{
    el.addEventListener('dragstart',e=>{
        e.dataTransfer.setData('type',el.dataset.type);
    });
});

document.getElementById('canvas').addEventListener('dragover',e=>e.preventDefault());
document.getElementById('canvas').addEventListener('drop',e=>{
    e.preventDefault();
    const type=e.dataTransfer.getData('type');
    addComponent(type,e.offsetX,e.offsetY);
});

function generateNetlist(){
    const uf={};
    function find(x){if(!(x in uf))uf[x]=x;return uf[x]==x?x:uf[x]=find(uf[x]);}
    function union(a,b){a=find(a);b=find(b);if(a!=b)uf[a]=b;}
    const allE=[];
    instance.getAllConnections().forEach(c=>{
        union(c.endpoints[0].getUuid(),c.endpoints[1].getUuid());
    });
    document.querySelectorAll('.component').forEach(div=>{
        const t=div.dataset.type,id=div.id;
        if(t==='GND'){allE.push(id+'-g');uf[id+'-g']=id+'-g';}
        else{allE.push(id+'-a');allE.push(id+'-b');}
    });
    const nodeMap={};
    let next=1;
    allE.forEach(ep=>{
        const root=find(ep);
        const comp=ep.split('-')[0];
        if(document.getElementById(comp).dataset.type==='GND')nodeMap[root]=0;
    });
    allE.forEach(ep=>{const r=find(ep);if(nodeMap[r]==null)nodeMap[r]=next++;});
    const lines=[];
    document.querySelectorAll('.component').forEach(div=>{
        const t=div.dataset.type,id=div.id;
        if(t==='GND')return;
        const n1=nodeMap[find(id+'-a')];
        const n2=nodeMap[find(id+'-b')];
        const val=div.dataset.value||'1';
        const pref=div.dataset.prefix||'';
        if(t==='R')lines.push(`${id} ${n1} ${n2} ${val}${pref}`);
        if(t==='C')lines.push(`${id} ${n1} ${n2} ${val}${pref}`);
        if(t==='V')lines.push(`${id} ${n1} ${n2} DC ${val}${pref}`);
    });
    lines.push('.tran 1m 20m');
    const nodes=Object.values(nodeMap).filter(n=>n!==0);
    if(nodes.length)lines.push('.print tran '+nodes.map(n=>`v(${n})`).join(' '));
    lines.push('.end');
    document.getElementById('netlist').value=lines.join('\n');
}
</script>
{% if data %}
<script>
const data={{ data|safe }};
const times=data.map(r=>r[0]);
const s1=data.map(r=>r[1]);
const s2=data[0].length>2?data.map(r=>r[2]):[];
new Chart(document.getElementById('chart'),{
    type:'line',
    data:{labels:times,datasets:[{label:'V(node1)',data:s1,borderColor:'red',fill:false},{label:'V(node2)',data:s2,borderColor:'blue',fill:false}]},
    options:{scales:{x:{title:{display:true,text:'Time (s)'}},y:{title:{display:true,text:'Voltage (V)'}}}}
});
</script>
{% endif %}
</body>
</html>
